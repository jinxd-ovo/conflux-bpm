function TaskFactory(){this.build=function(n,t,i,r,u,f,e){var o=computeStart(u),s=computeEndByDuration(o,f);return new Task(n,t,i,r,o,s,f,e)}}function Task(n,t,i,r,u,f,e,o){this.id=n;this.name=t;this.progress=0;this.description="";this.code=i;this.level=r;this.status="STATUS_UNDEFINED";this.depends="";this.canWrite=!0;this.start=u;this.duration=e;this.end=f;this.startIsMilestone=!1;this.endIsMilestone=!1;this.collapsed=o;this.rowElement;this.ganttElement;this.master;this.assigs=[]}function updateTree(n){var t=n.getParent(),i,r;if(!t)return!0;if(i=t.start,r=t.end,t.start>n.start){if(t.startIsMilestone)return n.master.setErrorOnTransaction(GanttMaster.messages.START_IS_MILESTONE+"\n"+t.name,n),!1;if(t.depends)return n.master.setErrorOnTransaction(GanttMaster.messages.TASK_HAS_CONSTRAINTS+"\n"+t.name,n),!1;i=n.start}if(t.end<n.end){if(t.endIsMilestone)return n.master.setErrorOnTransaction(GanttMaster.messages.END_IS_MILESTONE+"\n"+t.name,n),!1;r=n.end}return i!=t.start||r!=t.end?t.canWrite?t.hasExternalDep?(n.master.setErrorOnTransaction(GanttMaster.messages.TASK_HAS_EXTERNAL_DEPS+"\n"+t.name,n),!1):t.setPeriod(i,r):(n.master.setErrorOnTransaction(GanttMaster.messages.CANNOT_WRITE+"\n"+t.name,n),!1):!0}function Link(n,t,i){this.from=n;this.to=t;this.lag=i}function Assignment(n,t,i,r){this.id=n;this.resourceId=t;this.roleId=i;this.effort=r}function Resource(n,t){this.id=n;this.name=t}function Role(n,t){this.id=n;this.name=t}Task.prototype.clone=function(){var t={};for(var n in this)typeof this[n]!="function"&&(t[n]=this[n]);return t};Task.prototype.getAssigsString=function(){for(var r,i,n="",t=0;t<this.assigs.length;t++)r=this.assigs[t],i=this.master.getResource(r.resourceId),i&&(n=n+(n==""?"":", ")+i.name);return n};Task.prototype.createAssignment=function(n,t,i,r){var u=new Assignment(n,t,i,r);return this.assigs.push(u),u};Task.prototype.setPeriod=function(n,t){var s,v,f,e,h,b,y,o,i,r;if(n instanceof Date&&(n=n.getTime()),t instanceof Date&&(t=t.getTime()),s={start:this.start,end:this.end,duration:this.duration},v=n,n>t&&(n=t),n=computeStart(n),f=this.getSuperiors(),f&&f.length>0){for(e=0,i=0;i<f.length;i++)r=f[i],e=Math.max(e,incrementDateByWorkingDays(r.from.end,r.lag));if(computeStart(e)!=n)return this.moveTo(e+1,!1)}if(h=!1,b=new Date(n),(this.start!=n||this.start!=v)&&(this.start=n,h=!0),y=t,t=computeEnd(t),(this.end!=t||this.end!=y)&&(this.end=t,h=!0),this.duration=recomputeDuration(this.start,this.end),!h)return!0;if(!this.canWrite)return this.master.setErrorOnTransaction(GanttMaster.messages.CANNOT_WRITE+"\n"+this.name,this),!1;if(this.hasExternalDep)return this.master.setErrorOnTransaction(GanttMaster.messages.TASK_HAS_EXTERNAL_DEPS+"\n"+this.name,this),!1;var u=!0,k=s.duration-this.duration,c=k>0,d=c&&s.start<this.start,p=c&&s.end>this.end;if(c){var w=this.getChildren(),l=Infinity,a=0;for(i=0;i<w.length;i++)ch=w[i],p?a=Math.max(a,ch.end):l=Math.min(l,ch.start);p?this.end=Math.max(a,this.end):this.start=Math.min(l,this.start);this.duration=recomputeDuration(this.start,this.end)}else(this.start<this.master.minEditableDate||this.end>this.master.maxEditableDate)&&(this.master.setErrorOnTransaction(GanttMaster.messages.CHANGE_OUT_OF_SCOPE,this),u=!1),u&&!updateTree(this)&&(u=!1);if(u&&(o=this.getInferiors(),o&&o.length>0))for(i=0;i<o.length;i++){if(r=o[i],!r.to.canWrite){this.master.setErrorOnTransaction(GanttMaster.messages.CANNOT_WRITE+"\n"+r.to.name,r.to);break}if(u=r.to.moveTo(t,!1),!u)break}return u};Task.prototype.moveTo=function(n,t){var h,c,u,o,f,l,s,e,i,r;if(n instanceof Date&&(n=n.getTime()),h={start:this.start,end:this.end},c=n,n=computeStart(n),!t&&this.startIsMilestone&&n!=this.start)return this.master.setErrorOnTransaction(GanttMaster.messages.START_IS_MILESTONE,this),!1;if(this.hasExternalDep)return this.master.setErrorOnTransaction(GanttMaster.messages.TASK_HAS_EXTERNAL_DEPS,this),!1;if(u=this.getSuperiors(),u&&u.length>0){for(o=0,i=0;i<u.length;i++)r=u[i],o=Math.max(o,incrementDateByWorkingDays(r.from.end,r.lag));n=o+1}if(n=computeStart(n),f=computeEndByDuration(n,this.duration),this.start!=n||this.start!=c){if(!t&&this.endIsMilestone&&(f=this.end,this.duration=recomputeDuration(n,f)),this.start=n,this.end=f,this.start<this.master.minEditableDate||this.end>this.master.maxEditableDate)return this.master.setErrorOnTransaction(GanttMaster.messages.CHANGE_OUT_OF_SCOPE,this),!1;for(l=h.start-this.start,s=this.getChildren(),i=0;i<s.length;i++)if(ch=s[i],!ch.moveTo(ch.start-l,!1))return!1;if(!updateTree(this))return!1;if(e=this.getInferiors(),e&&e.length>0)for(i=0;i<e.length;i++)if(r=e[i],r.to.canWrite){if(!r.to.moveTo(f,!1))return!1}else this.master.setErrorOnTransaction(GanttMaster.messages.CANNOT_WRITE+"\n"+r.to.name,r.to)}return!0};Task.prototype.changeStatus=function(n){function t(n,u,f,e,o){var v=n.status,c,l,y,a,h,s;if(u==v)return!0;if(c=!0,n.status=u,n.master.cannotCloseTaskIfIssueOpen&&u=="STATUS_DONE"&&n.openIssues>0)return n.master.setErrorOnTransaction(GanttMaster.messages.CANNOT_CLOSE_TASK_IF_OPEN_ISSUE+" "+n.name),!1;if(u=="STATUS_DONE")if(f||v!="STATUS_FAILED"){for(l=n.getSuperiors(),s=0;s<l.length;s++)if(i.indexOf(l[s].from)<0&&l[s].from.status!="STATUS_DONE"){(f||e)&&n.master.setErrorOnTransaction(GanttMaster.messages.GANTT_ERROR_DEPENDS_ON_OPEN_TASK+"\n"+l[s].from.name+" -> "+n.name);c=!1;break}if(c){for(h=n.getChildren(),s=0;s<h.length;s++)t(h[s],"STATUS_DONE",!1,!0,!1);r(i,n.getInferiors(),"STATUS_ACTIVE")}}else c=!1;else if(u=="STATUS_ACTIVE")if(f||v!="STATUS_FAILED"){if(a=n.getParent(),a&&a.status!="STATUS_ACTIVE"&&(c=t(a,"STATUS_ACTIVE",!1,!1,!0)),c)for(l=n.getSuperiors(),s=0;s<l.length;s++)if(l[s].from.status!="STATUS_DONE"){(f||o)&&n.master.setErrorOnTransaction(GanttMaster.messages.GANTT_ERROR_DEPENDS_ON_OPEN_TASK+"\n"+l[s].from.name+" -> "+n.name);c=!1;break}if(c){if(h=n.getChildren(),v=="STATUS_UNDEFINED"||v=="STATUS_SUSPENDED")for(s=0;s<h.length;s++)h[s].status!="STATUS_DONE"&&t(h[s],"STATUS_ACTIVE",!1,!0,!1);for(y=n.getInferiors(),s=0;s<y.length;s++)t(y[s].to,"STATUS_SUSPENDED",!1,!1,!1)}}else c=!1;else if(u=="STATUS_SUSPENDED"||u=="STATUS_UNDEFINED")if(f||v!="STATUS_FAILED"){for(a=n.getParent(),a&&a.status!="STATUS_ACTIVE"&&(c=t(a,u,!1,!1,!0)),h=n.getChildren(),s=0;s<h.length;s++)h[s].status!="STATUS_DONE"&&t(h[s],u,!1,!0,!1);r(i,n.getInferiors(),u)}else c=!1;else if(u=="STATUS_FAILED"){for(h=n.getChildren(),s=0;s<h.length;s++)t(h[s],"STATUS_FAILED",!1,!0,!1);r(i,n.getInferiors(),"STATUS_FAILED")}return c||(n.status=v),c}function r(n,i,r){for(var u=0;u<i.length;u++)n.indexOf(i[u].to)<0&&t(i[u].to,r,!1,!1,!1)}var i=this.getDescendant(),u=!0,f=this.status;return u=t(this,n,!0,!1,!1),u||(this.status=f),u};Task.prototype.synchronizeStatus=function(){var n=this.status;return this.status="",this.changeStatus(n)};Task.prototype.isLocallyBlockedByDependencies=function(){for(var t=this.getSuperiors(),i=!1,n=0;n<t.length;n++)if(t[n].from.status!="STATUS_DONE"){i=!0;break}return i};Task.prototype.getRow=function(){return ret=-1,this.master&&(ret=this.master.tasks.indexOf(this)),ret};Task.prototype.getParents=function(){var i,r,u,n,t;if(this.master)for(r=this.level,u=this.getRow(),i=[],n=u;n>=0;n--)t=this.master.tasks[n],r>t.level&&(r=t.level,i.push(t));return i};Task.prototype.getParent=function(){var i,n,t;if(this.master)for(n=this.getRow();n>=0;n--)if(t=this.master.tasks[n],this.level>t.level){i=t;break}return i};Task.prototype.isParent=function(){var t=!1,n;return this.master&&(n=this.getRow(),n<this.master.tasks.length-1&&(t=this.master.tasks[n+1].level>this.level)),t};Task.prototype.getChildren=function(){var i=[],r,n,t;if(this.master)for(r=this.getRow(),n=r+1;n<this.master.tasks.length;n++)if(t=this.master.tasks[n],t.level==this.level+1)i.push(t);else if(t.level<=this.level)break;return i};Task.prototype.getDescendant=function(){var i=[],r,n,t;if(this.master)for(r=this.getRow(),n=r+1;n<this.master.tasks.length;n++)if(t=this.master.tasks[n],t.level>this.level)i.push(t);else break;return i};Task.prototype.getSuperiors=function(){var n=[],t=this;return this.master&&(n=this.master.links.filter(function(n){return n.to==t})),n};Task.prototype.getSuperiorTasks=function(){for(var t=[],i=this.getSuperiors(),n=0;n<i.length;n++)t.push(i[n].from);return t};Task.prototype.getInferiors=function(){var n=[],t=this;return this.master&&(n=this.master.links.filter(function(n){return n.from==t})),n};Task.prototype.getInferiorTasks=function(){for(var t=[],i=this.getInferiors(),n=0;n<i.length;n++)t.push(i[n].to);return t};Task.prototype.deleteTask=function(){var t,n,i;for(this.rowElement.remove(),this.ganttElement.remove(),t=this.getChildren(),n=0;n<t.length;n++)t[n].isNew()||this.master.deletedTaskIds.push(t[n].id),t[n].deleteTask();this.isNew()||this.master.deletedTaskIds.push(this.id);this.master.tasks.splice(this.getRow(),1);i=this;this.master.links=this.master.links.filter(function(n){return n.from!=i&&n.to!=i})};Task.prototype.isNew=function(){return(this.id+"").indexOf("tmp_")==0};Task.prototype.isDependent=function(n){for(var r=this,i=this.master.links.filter(function(n){return n.from==r}),t=0;t<i.length;t++)if(i[t].to==n)return!0;for(t=0;t<i.length;t++)if(i[t].to.isDependent(n))return!0;return!1};Task.prototype.setLatest=function(n){this.latestStart=n-this.criticalCost;this.latestFinish=this.latestStart+this.duration};Task.prototype.indent=function(){var r=this.getRow(),u,e,t,n,i,o;if(r<=0)return!1;var f=!1,s=this.master.tasks[r-1],h=this.level+1;if(h<=s.level+1){for(f=!0,this.level++,u=this.getParents(),this.level--,e=this.level,t=r;t<this.master.tasks.length;t++)if(n=this.master.tasks[t],n.level>e||n==this)n.level++,this.master.links=this.master.links.filter(function(t){var i=!1;return t.to==n?i=u.indexOf(t.from)>=0:t.from==n&&(i=u.indexOf(t.to)>=0),!i});else break;i=this.getParent();i&&!this.depends&&(o=computeEndByDuration(i.start,this.duration),this.master.changeTaskDates(this,i.start,o));this.master.isLevelCode&&this.master.levelCode();this.master.updateDependsStrings();this.setPeriod(this.start+1,this.end+1);this.synchronizeStatus()}return f};Task.prototype.outdent=function(){var r,f,e,i,u,t,n;if(this.level<=1)return!1;for(r=!1,f=this.level,r=!0,e=this.getRow(),n=e;n<this.master.tasks.length;n++)if(i=this.master.tasks[n],i.level>f||i==this)i.level--;else break;for(u=this,t=this.getChildren(),this.master.links=this.master.links.filter(function(n){var i=n.to==u&&t.indexOf(n.from)>=0||n.from==u&&t.indexOf(n.to)>=0;return!i}),n=0;n<t.length;n++)t[n].setPeriod(t[n].start+1,t[n].end+1);return this.master.isLevelCode&&this.master.levelCode(),this.master.updateDependsStrings(),this.setPeriod(this.start+1,this.end+1),this.synchronizeStatus(),r};Task.prototype.moveUp=function(){var u=!1,t=this.getRow(),n,i,r,e,o,s,f,h;if(t<=0)return!1;for(n=t-1;n>=0;n--)if(this.master.tasks[n].level<=this.level)break;if(this.master.tasks[n].level==this.level){for(u=!0,i=0,r=t+1;r<this.master.tasks.length;r++)if(e=this.master.tasks[r],e.level>this.level)i++;else break;o=this.master.tasks.splice(t,i+1);s=this.master.tasks.splice(0,n);this.master.tasks=[].concat(s,o,this.master.tasks);f=this.master.editor.element.find("tr[taskId]");h=f.slice(t,t+i+1);f.eq(n).before(h);this.master.isLevelCode&&this.master.levelCode();this.master.updateDependsStrings()}else this.master.setErrorOnTransaction(GanttMaster.messages.TASK_MOVE_INCONSISTENT_LEVEL,this),u=!1;return u};Task.prototype.moveDown=function(){var t=this.getRow(),u,n,i,r,f,e,o;if(t>=this.master.tasks.length-1||t==0)return!1;for(u=!1,n=t+1;n<this.master.tasks.length;n++)if(this.master.tasks[n].level<=this.level)break;if(this.master.tasks[n]&&this.master.tasks[n].level==this.level){for(u=!0,n=n+1;n<this.master.tasks.length;n++)if(this.master.tasks[n].level<=this.level)break;for(i=0,r=t+1;r<this.master.tasks.length;r++)if(f=this.master.tasks[r],f.level>this.level)i++;else break;e=this.master.tasks.splice(t,i+1);o=this.master.tasks.splice(0,n-i-1);this.master.tasks=[].concat(o,e,this.master.tasks);var s=this.master.editor.element.find("tr[taskId]"),h=s.eq(n-1),c=s.slice(t,t+i+1);h.after(c);this.master.isLevelCode&&this.master.levelCode();this.master.updateDependsStrings()}return u};