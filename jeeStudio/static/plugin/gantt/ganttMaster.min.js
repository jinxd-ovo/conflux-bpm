function GanttMaster(){this.tasks=[];this.deletedTaskIds=[];this.links=[];this.editor;this.gantt;this.element;this.resources;this.roles;this.minEditableDate=0;this.maxEditableDate=Infinity;this.canWriteOnParent=!0;this.canWrite=!0;this.firstDayOfWeek=Date.firstDayOfWeek;this.currentTask;this.__currentTransaction;this.__undoStack=[];this.__redoStack=[];this.__inUndoRedo=!1;this.isBrowserTaskBar=!1;this.isLevelCode=!1;var n=this}GanttMaster.prototype.init=function(n){var t,i;this.element=n;t=this;$("#gantEditorTemplates").loadTemplates().remove();this.editor=new GridEditor(this);n.append(this.editor.gridified);this.gantt=new Ganttalendar("m",(new Date).getTime()-1728e5,(new Date).getTime()+1296e6,this,n.width()*.6);i=$.splittify.init(n,this.editor.gridified,this.gantt.element,60);t.splitter=i;n.before($.JST.createFromTemplate({},"GANTBUTTONS"));n.bind("refreshTasks.gantt",function(){t.redrawTasks()}).bind("refreshTask.gantt",function(n,i){t.drawTask(i)}).bind("deleteCurrentTask.gantt",function(){t.deleteCurrentTask()}).bind("addAboveCurrentTask.gantt",function(){t.addAboveCurrentTask()}).bind("addBelowCurrentTask.gantt",function(){t.addBelowCurrentTask()}).bind("indentCurrentTask.gantt",function(){t.indentCurrentTask()}).bind("outdentCurrentTask.gantt",function(){t.outdentCurrentTask()}).bind("moveUpCurrentTask.gantt",function(){t.moveUpCurrentTask()}).bind("moveDownCurrentTask.gantt",function(){t.moveDownCurrentTask()}).bind("zoomPlus.gantt",function(){t.gantt.zoomGantt(!0)}).bind("zoomMinus.gantt",function(){t.gantt.zoomGantt(!1)}).bind("undo.gantt",function(){t.canWrite&&t.undo()}).bind("redo.gantt",function(){t.canWrite&&t.redo()}).bind("resize.gantt",function(){t.resize()});$("body").bind("keydown.body",function(n){var r,i;if(n.target.nodeName.toLowerCase()=="body"||n.target.nodeName.toLowerCase()=="svg"){r=!0;switch(n.keyCode){case 46:case 8:i=t.gantt.element.find(".focused.focused");i.is(".taskBox")?t.deleteCurrentTask():i.is(".linkGroup")&&t.removeLink(i.data("from"),i.data("to"));break;case 38:if(t.currentTask)if(t.currentTask.ganttElement.is(".focused")){t.moveUpCurrentTask();t.gantt.element.oneTime(100,function(){t.currentTask.ganttElement.addClass("focused")})}else t.currentTask.rowElement.prev().click();break;case 40:if(t.currentTask)if(t.currentTask.ganttElement.is(".focused")){t.moveDownCurrentTask();t.gantt.element.oneTime(100,function(){t.currentTask.ganttElement.addClass("focused")})}else t.currentTask.rowElement.next().click();break;case 39:if(t.currentTask&&t.currentTask.ganttElement.is(".focused")){t.indentCurrentTask();t.gantt.element.oneTime(100,function(){t.currentTask.ganttElement.addClass("focused")})}break;case 37:if(t.currentTask&&t.currentTask.ganttElement.is(".focused")){t.outdentCurrentTask();t.gantt.element.oneTime(100,function(){t.currentTask.ganttElement.addClass("focused")})}break;case 89:n.ctrlKey&&t.redo();break;case 90:n.ctrlKey&&t.undo();break;default:r=!1}r&&(n.preventDefault(),n.stopPropagation())}})};GanttMaster.messages={CANNOT_WRITE:"CANNOT_WRITE",CHANGE_OUT_OF_SCOPE:"NO_RIGHTS_FOR_UPDATE_PARENTS_OUT_OF_EDITOR_SCOPE",START_IS_MILESTONE:"START_IS_MILESTONE",END_IS_MILESTONE:"END_IS_MILESTONE",TASK_HAS_CONSTRAINTS:"TASK_HAS_CONSTRAINTS",GANTT_ERROR_DEPENDS_ON_OPEN_TASK:"GANTT_ERROR_DEPENDS_ON_OPEN_TASK",GANTT_ERROR_DESCENDANT_OF_CLOSED_TASK:"GANTT_ERROR_DESCENDANT_OF_CLOSED_TASK",TASK_HAS_EXTERNAL_DEPS:"TASK_HAS_EXTERNAL_DEPS",GANTT_ERROR_LOADING_DATA_TASK_REMOVED:"GANTT_ERROR_LOADING_DATA_TASK_REMOVED",CIRCULAR_REFERENCE:"CIRCULAR_REFERENCE",ERROR_SETTING_DATES:"ERROR_SETTING_DATES",CANNOT_DEPENDS_ON_ANCESTORS:"CANNOT_DEPENDS_ON_ANCESTORS",CANNOT_DEPENDS_ON_DESCENDANTS:"CANNOT_DEPENDS_ON_DESCENDANTS",INVALID_DATE_FORMAT:"INVALID_DATE_FORMAT",GANTT_QUARTER_SHORT:"GANTT_QUARTER_SHORT",GANTT_SEMESTER_SHORT:"GANTT_SEMESTER_SHORT",CANNOT_CLOSE_TASK_IF_OPEN_ISSUE:"CANNOT_CLOSE_TASK_IF_OPEN_ISSUE"};GanttMaster.prototype.createTask=function(n,t,i,r,u,f){var e=new TaskFactory;return e.build(n,t,i,r,u,f)};GanttMaster.prototype.createResource=function(n,t){return new Resource(n,t)};GanttMaster.prototype.updateDependsStrings=function(){for(var t,i,n=0;n<this.tasks.length;n++)this.tasks[n].depends="";for(n=0;n<this.links.length;n++)t=this.links[n],i=t.to.depends,t.to.depends=t.to.depends+(t.to.depends==""?"":",")+(t.from.getRow()+1)+(t.lag?":"+t.lag:"")};GanttMaster.prototype.removeLink=function(n,t){var r,i;if(this.canWrite&&(n.canWrite||t.canWrite)){for(this.beginTransaction(),r=!1,i=0;i<this.links.length;i++)if(this.links[i].from==n&&this.links[i].to==t){this.links.splice(i,1);r=!0;break}r&&(this.updateDependsStrings(),this.updateLinks(t)&&this.changeTaskDates(t,t.start,t.end));this.endTransaction()}};GanttMaster.prototype.addTask=function(n,t){var i,r,f,u;for(n.master=this,i=-1,r=0;r<this.tasks.length;r++)if(n.id==this.tasks[r].id){i=r;break}return i>=0&&(this.tasks.splice(i,1),t=parseInt(i)),typeof t!="number"?this.tasks.push(n):(this.tasks.splice(t,0,n),this.updateDependsStrings()),f=!this.updateLinks(n),n.status=n.getParent()?n.getParent().status:"STATUS_ACTIVE",u=n,f||!n.setPeriod(n.start,n.end)?(this.tasks.splice(n.getRow(),1),u=undefined):(this.editor.addTask(n,t),this.gantt.addTask(n),this.isLevelCode&&this.levelCode()),u};GanttMaster.prototype.loadProject=function(n){this.beginTransaction();this.resources=n.resources;this.roles=n.roles;this.canWrite=n.canWrite;this.canWriteOnParent=n.canWriteOnParent;this.cannotCloseTaskIfIssueOpen=n.cannotCloseTaskIfIssueOpen;this.minEditableDate=n.minEditableDate?computeStart(n.minEditableDate):-Infinity;this.maxEditableDate=n.maxEditableDate?computeEnd(n.maxEditableDate):Infinity;this.loadTasks(n.tasks,n.selectedRow);this.deletedTaskIds=[];this.gantt.refreshGantt();this.endTransaction();var t=this;this.gantt.element.oneTime(200,function(){t.gantt.centerOnToday()})};GanttMaster.prototype.loadTasks=function(n,t){var o=new TaskFactory,f,u,r,i,e;for(this.reset(),r=0;r<n.length;r++){if(i=n[r],!(i instanceof Task)){f=o.build(i.id,i.name,i.code,i.level,i.start,i.duration,i.collapsed);for(u in i)u!="end"&&u!="start"&&(f[u]=i[u]);i=f}i.master=this;this.tasks.push(i)}for(r=0;r<this.tasks.length;r++)i=this.tasks[r],e=!this.updateLinks(i),e||!i.setPeriod(i.start,i.end)?(alert(GanttMaster.messages.GANNT_ERROR_LOADING_DATA_TASK_REMOVED+"\n"+i.name+"\n"+(e?GanttMaster.messages.CIRCULAR_REFERENCE:GanttMaster.messages.ERROR_SETTING_DATES)),this.tasks.splice(i.getRow(),1)):(this.editor.addTask(i,null,!0),this.gantt.addTask(i));this.editor.fillEmptyLines();this.tasks&&this.tasks.length>0&&(t=t?t:0,this.tasks[t].rowElement.click())};GanttMaster.prototype.levelCode=function(){function r(n,t){var f,i,u;if(n&&n.length>0)for(f=1,i=0;i<n.length;i++)u=n[i],u.code=t+"."+f,r(u.getChildren(),u.code),f++}var i,t,n;if(this.tasks&&this.tasks.length>0)for(i=1,t=0;t<this.tasks.length;t++)n=this.tasks[t],n.level==0&&(n.code=i,r(n.getChildren(),n.code),i++)};GanttMaster.prototype.browserTaskBar=function(n){if(n&&n instanceof Task){var s=n.id,t=$('svg[taskid="'+s+'"]'),u=parseFloat($(t)[0].getAttribute("x")),f=parseFloat($(t)[0].getBoundingClientRect().width),h=$(t).parent().parent().parent(),c=parseFloat($(h).width()),i=$(t).parent().parent().parent().parent(),e=parseFloat($(i).width()),l=u+f/2,r=l-e/2,o=$(i).scrollLeft();if(Math.abs(o-r)>=1)$(i).scrollLeft(r);else return;console.log("-------------------------------------------------------");console.log("task left:"+u);console.log("task width:"+f);console.log("canvas width:"+c);console.log("scroll width:"+e);console.log("scroll left position(old):"+o);console.log("scroll left position(new):"+r);console.log("-------------------------------------------------------")}};GanttMaster.prototype.getTask=function(n){for(var i,r,t=0;t<this.tasks.length;t++)if(i=this.tasks[t],i.id==n){r=i;break}return r};GanttMaster.prototype.getResource=function(n){for(var i,r,t=0;t<this.resources.length;t++)if(i=this.resources[t],i.id==n){r=i;break}return r};GanttMaster.prototype.changeTaskDates=function(n,t,i){return n.setPeriod(t,i)};GanttMaster.prototype.moveTask=function(n,t){return n.moveTo(t,!0)};GanttMaster.prototype.taskIsChanged=function(){var n=this;this.element.stopTime("gnnttaskIsChanged");this.element.oneTime(50,"gnnttaskIsChanged",function(){n.editor.redraw();n.gantt.refreshGantt();self.isLevelCode&&self.LevelCode()})};GanttMaster.prototype.redraw=function(){this.editor.redraw();this.gantt.refreshGantt()};GanttMaster.prototype.reset=function(){this.tasks=[];this.links=[];this.deletedTaskIds=[];this.__inUndoRedo?this.__inUndoRedo=!1:(this.__undoStack=[],this.__redoStack=[]);delete this.currentTask;this.editor.reset();this.gantt.reset()};GanttMaster.prototype.showTaskEditor=function(n){var t=this.getTask(n);t.rowElement.find(".edit").click()};GanttMaster.prototype.saveProject=function(){return this.saveGantt(!1)};GanttMaster.prototype.saveGantt=function(n){for(var f,i,t,u=[],r=0;r<this.tasks.length;r++)f=this.tasks[r],i=f.clone(),delete i.master,delete i.rowElement,delete i.ganttElement,u.push(i);return t={tasks:u},this.currentTask&&(t.selectedRow=this.currentTask.getRow()),t.deletedTaskIds=this.deletedTaskIds,n||(t.resources=this.resources,t.roles=this.roles,t.canWrite=this.canWrite,t.canWriteOnParent=this.canWriteOnParent),t};GanttMaster.prototype.updateLinks=function(n){function f(n,t,i){var u,e,c,o,r,s,h;if(t==n)return!0;for(u=n.getSuperiors(),e=n.getParent();e;)u=u.concat(e.getSuperiors()),e=e.getParent();for(c=n.getChildren(),r=0;r<c.length;r++)u=u.concat(c[r].getSuperiors());for(o=!1,r=0;r<u.length;r++)if(s=u[r],s.from==t){o=!0;break}else if(i.indexOf(s.from.id+"x"+t.id)<=0&&(i.push(s.from.id+"x"+t.id),f(s.from,t,i))){o=!0;break}return h=t.getParent(),h&&i.indexOf(n.id+"x"+h.id)<=0&&(i.push(n.id+"x"+h.id),f(n,h,i)&&(o=!0)),o}var i,u,t;if(this.links=this.links.filter(function(t){return t.to!=n}),i=!0,n.depends){var o=n.getParents(),s=n.getDescendant(),h=n.depends.split(","),r="",a=[];for(u=0;u<h.length;u++){var c=h[u],e=c.split(":"),l=0;e.length>1&&(l=parseInt(e[1]));t=this.tasks[parseInt(e[0]-1)];t&&(o&&o.indexOf(t)>=0?(this.setErrorOnTransaction(n.name+"\n"+GanttMaster.messages.CANNOT_DEPENDS_ON_ANCESTORS+"\n"+t.name),i=!1):s&&s.indexOf(t)>=0?(this.setErrorOnTransaction(n.name+"\n"+GanttMaster.messages.CANNOT_DEPENDS_ON_DESCENDANTS+"\n"+t.name),i=!1):f(t,n,a)?(i=!1,this.setErrorOnTransaction(GanttMaster.messages.CIRCULAR_REFERENCE+"\n"+n.name+" -> "+t.name)):(this.links.push(new Link(t,n,l)),r=r+(r.length>0?",":"")+c))}i&&(n.depends=r)}return i};GanttMaster.prototype.moveUpCurrentTask=function(){var n=this;n.canWrite&&n.currentTask&&(n.beginTransaction(),n.currentTask.moveUp(),n.endTransaction())};GanttMaster.prototype.moveDownCurrentTask=function(){var n=this;n.canWrite&&n.currentTask&&(n.beginTransaction(),n.currentTask.moveDown(),n.endTransaction())};GanttMaster.prototype.outdentCurrentTask=function(){var n=this,t;n.canWrite&&n.currentTask.canWrite&&n.currentTask&&(t=n.currentTask.getParent(),n.beginTransaction(),n.currentTask.outdent(),n.endTransaction(),t&&n.editor.refreshExpandStatus(t))};GanttMaster.prototype.indentCurrentTask=function(){var n=this;n.canWrite&&n.currentTask.canWrite&&n.currentTask&&(n.beginTransaction(),n.currentTask.indent(),n.endTransaction())};GanttMaster.prototype.addBelowCurrentTask=function(){var n=this,i,r,u,t;n.canWrite&&(i=new TaskFactory,n.beginTransaction(),u=0,n.currentTask?(r=i.build("tmp_"+(new Date).getTime(),"","",n.currentTask.level+1,n.currentTask.start,1),u=n.currentTask.getRow()+1):r=i.build("tmp_"+(new Date).getTime(),"","",0,(new Date).getTime(),1),t=n.addTask(r,u),t&&(t.rowElement.click(),t.rowElement.find("[name=name]").focus()),n.isLevelCode&&n.levelCode(),n.endTransaction())};GanttMaster.prototype.addAboveCurrentTask=function(){var n=this,i,r,u,t;if(n.canWrite){if(i=new TaskFactory,u=0,n.currentTask){if(n.currentTask.level<=0)return;r=i.build("tmp_"+(new Date).getTime(),"","",n.currentTask.level,n.currentTask.start,1);u=n.currentTask.getRow()}else r=i.build("tmp_"+(new Date).getTime(),"","",0,(new Date).getTime(),1);n.beginTransaction();t=n.addTask(r,u);t&&(t.rowElement.click(),t.rowElement.find("[name=name]").focus());n.isLevelCode&&n.levelCode();n.endTransaction()}};GanttMaster.prototype.deleteCurrentTask=function(){var n=this,t,i;n.currentTask&&n.canWrite&&n.currentTask.canWrite&&(t=n.currentTask.getRow(),n.currentTask&&(t>0||n.currentTask.isNew())&&(i=n.currentTask.getParent(),n.beginTransaction(),n.currentTask.deleteTask(),n.currentTask=undefined,n.isLevelCode&&n.levelCode(),n.updateDependsStrings(),n.redraw(),i&&n.editor.refreshExpandStatus(i),t=t>n.tasks.length-1?n.tasks.length-1:t,t>=0&&(n.currentTask=n.tasks[t],n.currentTask.rowElement.click(),n.currentTask.rowElement.find("[name=name]").focus()),n.endTransaction()))};GanttMaster.prototype.beginTransaction=function(){return this.__currentTransaction?console.error("Cannot open twice a transaction"):this.__currentTransaction={snapshot:JSON.stringify(this.saveGantt(!0)),errors:[]},this.__currentTransaction};GanttMaster.prototype.endTransaction=function(){var u,t,i,r,n,f;if(!this.__currentTransaction)return console.error("Transaction never started."),!0;if(u=!0,this.__currentTransaction.errors.length<=0){for(this.__undoStack.push(this.__currentTransaction.snapshot),this.__redoStack=[],this.gantt.originalStartMillis=Infinity,this.gantt.originalEndMillis=-Infinity,n=0;n<this.tasks.length;n++)t=this.tasks[n],this.gantt.originalStartMillis>t.start&&(this.gantt.originalStartMillis=t.start),this.gantt.originalEndMillis<t.end&&(this.gantt.originalEndMillis=t.end);this.taskIsChanged()}else{for(u=!1,i=JSON.parse(this.__currentTransaction.snapshot),this.deletedTaskIds=i.deletedTaskIds,this.loadTasks(i.tasks,i.selectedRow),this.redraw(),r="",n=0;n<this.__currentTransaction.errors.length;n++)f=this.__currentTransaction.errors[n],r=r+f.msg+"\n\n";alert(r)}return this.__currentTransaction=undefined,this.editor.refreshExpandStatus(this.currentTask),u};GanttMaster.prototype.setErrorOnTransaction=function(n,t){this.__currentTransaction?this.__currentTransaction.errors.push({msg:n,task:t}):console.error(n)};GanttMaster.prototype.checkpoint=function(){this.__undoStack=[];this.__redoStack=[]};GanttMaster.prototype.undo=function(){var t,n;this.__undoStack.length>0&&(t=this.__undoStack.pop(),this.__redoStack.push(JSON.stringify(this.saveGantt())),n=JSON.parse(t),this.deletedTaskIds=n.deletedTaskIds,this.__inUndoRedo=!0,this.loadTasks(n.tasks,n.selectedRow),this.redraw())};GanttMaster.prototype.redo=function(){var t,n;this.__redoStack.length>0&&(t=this.__redoStack.pop(),this.__undoStack.push(JSON.stringify(this.saveGantt())),n=JSON.parse(t),this.deletedTaskIds=n.deletedTaskIds,this.__inUndoRedo=!0,this.loadTasks(n.tasks,n.selectedRow),this.redraw())};GanttMaster.prototype.resize=function(){this.splitter.resize()};GanttMaster.prototype.getCollapsedDescendant=function(){for(var t,r=this.tasks,n=[],i=0;i<r.length;i++)(t=r[i],n.indexOf(t)>=0)||t.collapsed&&(n=n.concat(t.getDescendant()));return n};GanttMaster.prototype.computeCriticalPath=function(){function a(n,t){for(var i=0;i<t.length;i++)if(n.indexOf(t[i])<0)return!1;return!0}function v(n){for(var i,r=-1,t=0;t<n.length;t++)i=n[t],i.criticalCost>r&&(r=i.criticalCost);for(t=0;t<n.length;t++)i=n[t],i.setLatest(r)}function y(n){for(var i=[],t=0;t<n.length;t++)n[t].depends&&n[t].depends!=""||i.push(n[t]);return i}function p(n){for(var t,i=0;i<n.length;i++)t=n[i],t.earlyStart=0,t.earlyFinish=t.duration,l(t)}function l(n){for(var t,i=n.earlyFinish,u=n.getInferiorTasks(),r=0;r<u.length;r++)t=u[r],i>=t.earlyStart&&(t.earlyStart=i,t.earlyFinish=i+t.duration),l(t)}function w(n){for(var i,t=0;t<n.length;t++)i=n[t],i.isCritical=i.earlyStart==i.latestStart}var i,s,r,h,t,u,f,e,o,n,c;if(!this.tasks)return!1;for(i=this.tasks.filter(function(n){return!n.isParent()}),t=0;t<i.length;t++)n=i[t],n.earlyStart=-1,n.earlyFinish=-1,n.latestStart=-1,n.latestFinish=-1,n.criticalCost=-1,n.isCritical=!1;for(s=[],r=i.concat();r.length>0;){for(h=!1,t=0;t<r.length;t++)if(u=r[t],f=u.getInferiorTasks(),a(s,f)){for(e=0,o=0;o<f.length;o++)n=f[o],n.criticalCost>e&&(e=n.criticalCost);u.criticalCost=e+u.duration;s.push(u);r.splice(t,1);h=!0}if(!h)return console.error("Cyclic dependency, algorithm stopped!"),!1}return v(i),c=y(i),p(c),w(i),i};